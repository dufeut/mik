#!/bin/sh
# Pre-commit hook for Rust code quality
# Matches CI workflow for consistency
# Only runs on Rust-related changes (*.rs, Cargo.toml, Cargo.lock)

# Check if any Rust files are staged
RUST_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(rs)$|Cargo\.(toml|lock)$')

if [ -z "$RUST_FILES" ]; then
    # No Rust files changed, skip checks
    exit 0
fi

echo "Running Rust quality checks..."

# Format check (matches CI: cargo fmt --all -- --check)
echo "  -> Checking formatting..."
if ! cargo fmt --all -- --check > /dev/null 2>&1; then
    echo "ERROR: Format check failed. Run 'cargo fmt --all' to fix."
    exit 1
fi
echo "  OK: Formatting"

# Clippy (matches CI: cargo clippy --all-features -- -D warnings)
echo "  -> Running clippy..."
if ! cargo clippy --all-features -- -D warnings 2>&1 | tail -5; then
    echo "ERROR: Clippy found issues. Fix them before committing."
    exit 1
fi
echo "  OK: Clippy"

# Quick compile check (matches CI: cargo check --all-features)
echo "  -> Checking compilation..."
if ! cargo check --all-features > /dev/null 2>&1; then
    echo "ERROR: Compilation failed."
    exit 1
fi
echo "  OK: Compilation"

echo "All Rust checks passed!"
exit 0
