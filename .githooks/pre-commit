#!/usr/bin/env bash
#
# Pre-commit hook for mik - runs Rust quality checks on staged Rust files
# Matches CI workflow for consistency
#

set -e

# Check if any Rust-related files are staged
RUST_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(rs)$' || true)
CARGO_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '(Cargo\.toml|Cargo\.lock)$' || true)

# Exit early if no Rust files changed
if [ -z "$RUST_FILES" ] && [ -z "$CARGO_FILES" ]; then
    exit 0
fi

echo "Running Rust quality checks..."

# Check if cargo is available
if ! command -v cargo &> /dev/null; then
    echo "Error: cargo not found. Please install Rust."
    exit 1
fi

# 1. Format check
echo "  -> Checking formatting..."
if cargo fmt --all -- --check > /dev/null 2>&1; then
    echo "  OK: Formatting"
else
    echo "  FAIL: Formatting"
    echo "  Run 'cargo fmt --all' to fix"
    exit 1
fi

# 2. Clippy (use default features - rustls requires cmake on Windows)
echo "  -> Running clippy..."
if cargo clippy --all-targets -- -D warnings > /dev/null 2>&1; then
    echo "  OK: Clippy"
else
    echo "  FAIL: Clippy"
    echo "  Run 'cargo clippy --all-targets' to see errors"
    exit 1
fi

# 3. Compilation check
echo "  -> Checking compilation..."
if cargo check --all-targets > /dev/null 2>&1; then
    echo "  OK: Compilation"
else
    echo "  FAIL: Compilation"
    echo "  Run 'cargo check --all-targets' to see errors"
    exit 1
fi

echo "All Rust checks passed!"
